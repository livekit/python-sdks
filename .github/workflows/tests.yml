name: Tests

on:
  workflow_call:
    inputs:
      os:
        description: "Runner OS (e.g., ubuntu-latest, macos-latest, windows-latest)"
        required: true
        type: string
      python-version:
        description: "Python version to test"
        required: true
        type: string
      artifact-name:
        description: "Name of the wheel artifact to download"
        required: true
        type: string
      run-id:
        description: "Workflow run ID to download artifacts from (optional, uses current run if not specified)"
        required: false
        type: string
    secrets:
      LIVEKIT_URL:
        required: true
      LIVEKIT_API_KEY:
        required: true
      LIVEKIT_API_SECRET:
        required: true

jobs:
  test:
    name: Test (${{ inputs.os }}, Python ${{ inputs.python-version }})
    runs-on: ${{ inputs.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: true

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Download livekit-rtc wheel (current run)
        if: ${{ inputs.run-id == '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: rtc-wheel

      - name: Download livekit-rtc wheel (from specific run)
        if: ${{ inputs.run-id != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: rtc-wheel
          run-id: ${{ inputs.run-id }}
          github-token: ${{ github.token }}

      - name: Create venv and install dependencies (Unix)
        if: runner.os != 'Windows'
        run: |
          uv venv .test-venv
          source .test-venv/bin/activate
          uv pip install rtc-wheel/*.whl ./livekit-api ./livekit-protocol
          uv pip install pytest pytest-asyncio numpy matplotlib

      - name: Create venv and install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          uv venv .test-venv
          .test-venv\Scripts\activate
          uv pip install (Get-ChildItem rtc-wheel\*.whl).FullName .\livekit-api .\livekit-protocol
          uv pip install pytest pytest-asyncio numpy matplotlib
        shell: pwsh

      - name: Run tests (Unix)
        if: runner.os != 'Windows'
        env:
          LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
        run: |
          source .test-venv/bin/activate
          pytest tests/

      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        env:
          LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
        run: |
          .test-venv\Scripts\activate
          pytest tests/
        shell: pwsh
        